<div class="min-h-screen bg-gradient-to-br from-blue-50/30 to-white relative">
  <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
    
    <!-- Header Ultra-Professionnel -->
    <div *ngIf="false" class="relative">
      <div class="bg-white rounded-2xl border border-blue-200 shadow-lg p-8 lg:p-12">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-8">
          <div class="flex items-start gap-6">
            <div class="relative">
              <div class="w-20 h-20 bg-blue-600 rounded-2xl flex items-center justify-center shadow-lg">
                <mat-icon class="text-white text-4xl">cloud_upload</mat-icon>
              </div>
              <div class="absolute -bottom-1 -right-1 w-6 h-6 bg-green-500 rounded-full border-2 border-white flex items-center justify-center">
                <mat-icon class="text-white text-sm">add</mat-icon>
              </div>
            </div>
            <div class="space-y-3">
              <div class="flex items-center gap-3">
                <h1 class="text-3xl lg:text-4xl font-light text-slate-900 tracking-tight">
                Importation d'Étudiants
              </h1>
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 border border-blue-200">
                  CSV Import
                </span>
              </div>
              <p class="text-slate-600 text-lg leading-relaxed max-w-2xl">
                Importez et gérez massivement vos étudiants via un fichier CSV sécurisé avec validation automatique
              </p>
              <div class="flex items-center gap-6 text-sm text-slate-500">
                <span class="flex items-center gap-2">
                  <mat-icon class="text-green-500 text-base">verified</mat-icon>
                  Validation automatique
                </span>
                <span class="flex items-center gap-2">
                  <mat-icon class="text-blue-500 text-base">security</mat-icon>
                  Import sécurisé
                </span>
              </div>
            </div>
          </div>
          
          <div class="flex flex-col sm:flex-row gap-4">
            <button 
              (click)="downloadTemplate()"
              [disabled]="loading"
              class="inline-flex items-center justify-center px-8 py-4 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-xl hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50"
            >
              <mat-icon class="mr-3 text-xl">download</mat-icon>
              <span>{{ importMode === 'complete' ? 'Modèle complet' : 'Modèle minimal' }}</span>
            </button>
            
            <!-- Bouton supplémentaire pour mode complet -->
            <button 
              *ngIf="importMode === 'complete'"
              (click)="downloadTemplateWithIds()"
              [disabled]="loading"
              class="inline-flex items-center justify-center px-8 py-4 text-sm font-medium text-slate-700 bg-white border-2 border-slate-200 rounded-xl hover:bg-slate-50 hover:border-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-500 disabled:opacity-50"
            >
              <mat-icon class="mr-3 text-xl">table_chart</mat-icon>
              <span>Modèle avec IDs</span>
            </button>
            
            <button 
              (click)="goBack()"
              [disabled]="loading"
              class="inline-flex items-center justify-center px-8 py-4 text-sm font-medium text-slate-700 bg-white border-2 border-slate-200 rounded-xl hover:bg-slate-50 hover:border-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-500 disabled:opacity-50"
            >
              <mat-icon class="mr-3 text-xl">arrow_back</mat-icon>
              <span>Retour</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Sélecteur de Mode d'Importation -->
    <div class="relative mb-8">
      <div class="bg-white/90 backdrop-blur-sm rounded-3xl border border-white/30 shadow-xl shadow-blue-500/10 overflow-hidden">
        <!-- Header du sélecteur -->
        <div class="relative bg-gradient-to-r from-slate-50 to-blue-50/50 border-b border-slate-200/50 px-8 py-6">
          <div class="flex items-center gap-6">
            <div class="relative">
              <div class="w-14 h-14 bg-gradient-to-br from-indigo-600 to-purple-700 rounded-2xl flex items-center justify-center shadow-lg">
                <mat-icon class="text-white text-2xl">settings</mat-icon>
              </div>
              <div class="absolute -top-1 -right-1 w-5 h-5 bg-green-500 rounded-full border-2 border-white"></div>
            </div>
            <div class="space-y-2">
              <h2 class="text-2xl lg:text-3xl font-extralight text-slate-900 tracking-tight">
                Mode d'Importation
              </h2>
              <p class="text-slate-600 leading-relaxed">
                Choisissez comment vous souhaitez importer vos données
              </p>
            </div>
          </div>
        </div>
        
        <!-- Sélecteur de mode -->
        <div class="p-8">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Mode Importation Complète -->
            <div 
              class="relative group cursor-pointer"
              [class.ring-2]="importMode === 'complete'"
              [class.ring-blue-500]="importMode === 'complete'"
              (click)="changeImportMode('complete')"
            >
              <div class="absolute inset-0 bg-gradient-to-r from-blue-500/5 to-green-500/5 rounded-2xl transition-opacity group-hover:opacity-75"></div>
              <div class="relative bg-white/70 backdrop-blur-sm border border-slate-200/50 rounded-2xl p-6 transition-all duration-300 group-hover:shadow-xl group-hover:shadow-blue-500/10">
                <div class="flex items-center gap-4 mb-4">
                  <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-green-600 rounded-xl flex items-center justify-center shadow-lg">
                    <mat-icon class="text-white text-xl">auto_awesome</mat-icon>
                  </div>
                  <div class="flex-1">
                    <h3 class="text-lg font-semibold text-slate-900">Importation Complète</h3>
                    <p class="text-sm text-slate-500">Toutes les données dans le fichier</p>
                  </div>
                  <div class="flex-shrink-0">
                    <div class="w-6 h-6 rounded-full border-2 border-slate-300 flex items-center justify-center"
                         [class.bg-blue-500]="importMode === 'complete'"
                         [class.border-blue-500]="importMode === 'complete'">
                      <div *ngIf="importMode === 'complete'" class="w-2 h-2 bg-white rounded-full"></div>
                    </div>
                  </div>
                </div>
                <div class="space-y-3">
                  <div class="flex items-center gap-2 text-sm text-slate-600">
                    <mat-icon class="text-green-500 text-base">check_circle</mat-icon>
                    <span>Promotion, établissement, ville, groupe dans le fichier</span>
                  </div>
                  <div class="flex items-center gap-2 text-sm text-slate-600">
                    <mat-icon class="text-blue-500 text-base">psychology</mat-icon>
                    <span>Validation intelligente avec suggestions</span>
                  </div>
                  <div class="flex items-center gap-2 text-sm text-slate-600">
                    <mat-icon class="text-purple-500 text-base">speed</mat-icon>
                    <span>Importation directe sans pré-configuration</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Mode Pré-configuré -->
            <div 
              class="relative group cursor-pointer"
              [class.ring-2]="importMode === 'preconfigured'"
              [class.ring-blue-500]="importMode === 'preconfigured'"
              (click)="changeImportMode('preconfigured')"
            >
              <div class="absolute inset-0 bg-gradient-to-r from-orange-500/5 to-yellow-500/5 rounded-2xl transition-opacity group-hover:opacity-75"></div>
              <div class="relative bg-white/70 backdrop-blur-sm border border-slate-200/50 rounded-2xl p-6 transition-all duration-300 group-hover:shadow-xl group-hover:shadow-orange-500/10">
                <div class="flex items-center gap-4 mb-4">
                  <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-yellow-600 rounded-xl flex items-center justify-center shadow-lg">
                    <mat-icon class="text-white text-xl">tune</mat-icon>
                  </div>
                  <div class="flex-1">
                    <h3 class="text-lg font-semibold text-slate-900">Mode Pré-configuré</h3>
                    <p class="text-sm text-slate-500">Configuration globale + données minimales</p>
                  </div>
                  <div class="flex-shrink-0">
                    <div class="w-6 h-6 rounded-full border-2 border-slate-300 flex items-center justify-center"
                         [class.bg-orange-500]="importMode === 'preconfigured'"
                         [class.border-orange-500]="importMode === 'preconfigured'">
                      <div *ngIf="importMode === 'preconfigured'" class="w-2 h-2 bg-white rounded-full"></div>
                    </div>
                  </div>
                </div>
                <div class="space-y-3">
                  <div class="flex items-center gap-2 text-sm text-slate-600">
                    <mat-icon class="text-orange-500 text-base">settings</mat-icon>
                    <span>Configuration globale des relations</span>
                  </div>
                  <div class="flex items-center gap-2 text-sm text-slate-600">
                    <mat-icon class="text-yellow-500 text-base">description</mat-icon>
                    <span>Fichier avec données minimales</span>
                  </div>
                  <div class="flex items-center gap-2 text-sm text-slate-600">
                    <mat-icon class="text-red-500 text-base">warning</mat-icon>
                    <span>Mode legacy - moins flexible</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Information Mode Importation Complète -->
    <div *ngIf="importMode === 'complete'" class="relative mb-8">
      <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-3xl border border-green-200/50 shadow-xl p-8">
        <div class="flex items-start gap-6">
          <div class="flex-shrink-0">
            <div class="w-16 h-16 bg-gradient-to-br from-green-500 to-blue-600 rounded-2xl flex items-center justify-center shadow-lg">
              <mat-icon class="text-white text-2xl">rocket_launch</mat-icon>
            </div>
          </div>
          <div class="flex-1">
            <h3 class="text-2xl font-semibold text-slate-900 mb-4">
              Mode Importation Complète Activé
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="space-y-3">
                <div class="flex items-center gap-3">
                  <mat-icon class="text-green-500 text-lg">check_circle</mat-icon>
                  <span class="text-slate-700 font-medium">Toutes les données dans le fichier</span>
                </div>
                <div class="flex items-center gap-3">
                  <mat-icon class="text-blue-500 text-lg">psychology</mat-icon>
                  <span class="text-slate-700 font-medium">Validation intelligente automatique</span>
                </div>
                <div class="flex items-center gap-3">
                  <mat-icon class="text-purple-500 text-lg">speed</mat-icon>
                  <span class="text-slate-700 font-medium">Importation directe sans configuration</span>
                </div>
              </div>
              <div class="space-y-3">
                <div class="flex items-center gap-3">
                  <mat-icon class="text-orange-500 text-lg">lightbulb</mat-icon>
                  <span class="text-slate-700 font-medium">Suggestions automatiques en cas d'erreur</span>
                </div>
                <div class="flex items-center gap-3">
                  <mat-icon class="text-indigo-500 text-lg">auto_awesome</mat-icon>
                  <span class="text-slate-700 font-medium">Support IDs numériques ET noms textuels</span>
                </div>
                <div class="flex items-center gap-3">
                  <mat-icon class="text-pink-500 text-lg">table_chart</mat-icon>
                  <span class="text-slate-700 font-medium">Compatible CSV, TXT et Excel</span>
                </div>
              </div>
            </div>
            <div class="mt-6 p-4 bg-white/70 rounded-xl border border-green-200/50">
              <p class="text-slate-600 text-sm">
                <strong>Format recommandé :</strong> Incluez les colonnes <code class="bg-slate-100 px-2 py-1 rounded text-xs">promotion_id</code>, 
                <code class="bg-slate-100 px-2 py-1 rounded text-xs">etablissement_id</code>, 
                <code class="bg-slate-100 px-2 py-1 rounded text-xs">ville_id</code>, 
                <code class="bg-slate-100 px-2 py-1 rounded text-xs">group_id</code>, 
                <code class="bg-slate-100 px-2 py-1 rounded text-xs">option_id</code> dans votre fichier.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Configuration Professionnelle -->
    <div *ngIf="showConfiguration && importMode === 'preconfigured'" class="relative">
      <div class="bg-white/80 backdrop-blur-sm rounded-3xl border border-white/20 shadow-xl shadow-slate-500/5 overflow-hidden">
        <!-- Header Élégant -->
        <div class="relative bg-gradient-to-r from-slate-50 to-blue-50/50 border-b border-slate-200/50 px-8 py-6">
          <div class="flex items-center gap-6">
            <div class="relative">
              <div class="w-14 h-14 bg-gradient-to-br from-slate-600 to-slate-700 rounded-2xl flex items-center justify-center shadow-lg">
                <mat-icon class="text-white text-2xl">tune</mat-icon>
              </div>
              <div class="absolute -top-1 -right-1 w-5 h-5 bg-blue-500 rounded-full border-2 border-white"></div>
            </div>
            <div class="space-y-2">
              <h2 class="text-2xl lg:text-3xl font-extralight text-slate-900 tracking-tight">
                Configuration d'Importation
              </h2>
              <p class="text-slate-600 leading-relaxed">
                Définissez les paramètres globaux pour l'importation de vos étudiants
              </p>
            </div>
          </div>
        </div>
        
        <!-- Content Structuré -->
        <div class="p-8 lg:p-12">
        
          <form [formGroup]="configForm" class="space-y-10">
            <!-- Instructions Professionnelles -->
            <div class="relative">
              <div class="absolute inset-0 bg-gradient-to-r from-blue-500/5 to-indigo-500/5 rounded-2xl"></div>
              <div class="relative bg-gradient-to-r from-blue-50/50 to-indigo-50/30 border border-blue-200/50 rounded-2xl p-8">
                <div class="flex items-start gap-6">
                  <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg">
                      <mat-icon class="text-white text-xl">info</mat-icon>
                    </div>
              </div>
                  <div class="space-y-4">
                    <h4 class="text-xl font-semibold text-slate-900 tracking-tight">
                      Configuration des Relations
                    </h4>
                    <p class="text-slate-600 leading-relaxed text-lg">
                      Définissez les informations institutionnelles qui seront automatiquement assignées à tous les étudiants lors de l'importation. Ces paramètres garantissent la cohérence des données.
                    </p>
                    <div class="flex items-center gap-4 text-sm text-slate-500">
                      <span class="flex items-center gap-2">
                        <mat-icon class="text-emerald-500 text-base">check_circle</mat-icon>
                        Configuration globale
                      </span>
                      <span class="flex items-center gap-2">
                        <mat-icon class="text-blue-500 text-base">link</mat-icon>
                        Relations automatiques
                      </span>
                    </div>
                  </div>
                </div>
            </div>
          </div>

            <!-- Grid de Configuration Ultra-Moderne -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Promotion -->
              <div class="group relative">
                <div class="absolute inset-0 bg-gradient-to-r from-blue-500/5 to-cyan-500/5 rounded-2xl transition-opacity group-hover:opacity-75"></div>
                <div class="relative bg-white/70 backdrop-blur-sm border border-slate-200/50 rounded-2xl p-6 transition-all duration-300 group-hover:shadow-xl group-hover:shadow-blue-500/10">
                  <label class="block space-y-4">
                    <div class="flex items-center gap-4">
                      <div class="w-10 h-10 bg-white border-2 border-slate-200 rounded-xl flex items-center justify-center shadow-lg">
                        <mat-icon class="text-slate-600 text-lg">school</mat-icon>
                      </div>
                      <div class="flex-1">
                        <div class="flex items-center gap-2">
                          <span class="text-lg font-semibold text-slate-900">Promotion</span>
                          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">Requis</span>
                        </div>
                        <p class="text-sm text-slate-500 mt-1">Année d'étude des étudiants</p>
                      </div>
                </div>
              <select 
                formControlName="promotion_id" 
                      class="w-full px-4 py-4 text-slate-900 bg-white border-2 border-slate-200 rounded-xl transition-all duration-200 focus:outline-none focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 hover:border-slate-300 text-base"
              >
                      <option value="" class="text-slate-500">Sélectionnez une promotion</option>
                      <option *ngFor="let promotion of filterOptions.promotions" [value]="promotion.id" class="text-slate-900">
                  {{ promotion.name }}
                </option>
              </select>
                  </label>
                </div>
            </div>

            <!-- Établissement -->
              <div class="group relative">
                <div class="absolute inset-0 bg-gradient-to-r from-blue-500/5 to-blue-500/5 rounded-2xl transition-opacity group-hover:opacity-75"></div>
                <div class="relative bg-white/70 backdrop-blur-sm border border-slate-200/50 rounded-2xl p-6 transition-all duration-300 group-hover:shadow-xl group-hover:shadow-blue-500/10">
                  <label class="block space-y-4">
                    <div class="flex items-center gap-4">
                      <div class="w-10 h-10 bg-white border-2 border-slate-200 rounded-xl flex items-center justify-center shadow-lg">
                        <mat-icon class="text-slate-600 text-lg">business</mat-icon>
                      </div>
                      <div class="flex-1">
                        <div class="flex items-center gap-2">
                          <span class="text-lg font-semibold text-slate-900">Établissement</span>
                          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">Requis</span>
                        </div>
                        <p class="text-sm text-slate-500 mt-1">Institution d'enseignement</p>
                      </div>
                </div>
                    <select 
                      formControlName="etablissement_id" 
                      class="w-full px-4 py-4 text-slate-900 bg-white border-2 border-slate-200 rounded-xl transition-all duration-200 focus:outline-none focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 hover:border-slate-300 text-base"
                    >
                      <option value="" class="text-slate-500">Sélectionnez un établissement</option>
                      <option *ngFor="let etablissement of filterOptions.etablissements" [value]="etablissement.id" class="text-slate-900">
                  {{ etablissement.name }}
                </option>
              </select>
                  </label>
                </div>
            </div>

            <!-- Ville -->
              <div class="group relative">
                <div class="absolute inset-0 bg-gradient-to-r from-blue-500/5 to-blue-500/5 rounded-2xl transition-opacity group-hover:opacity-75"></div>
                <div class="relative bg-white/70 backdrop-blur-sm border border-slate-200/50 rounded-2xl p-6 transition-all duration-300 group-hover:shadow-xl group-hover:shadow-blue-500/10">
                  <label class="block space-y-4">
                    <div class="flex items-center gap-4">
                      <div class="w-10 h-10 bg-white border-2 border-slate-200 rounded-xl flex items-center justify-center shadow-lg">
                        <mat-icon class="text-slate-600 text-lg">location_city</mat-icon>
                      </div>
                      <div class="flex-1">
                        <div class="flex items-center gap-2">
                          <span class="text-lg font-semibold text-slate-900">Ville</span>
                          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">Requis</span>
                        </div>
                        <p class="text-sm text-slate-500 mt-1">Localisation géographique</p>
                      </div>
                </div>
                    <select 
                      formControlName="ville_id" 
                      class="w-full px-4 py-4 text-slate-900 bg-white border-2 border-slate-200 rounded-xl transition-all duration-200 focus:outline-none focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 hover:border-slate-300 text-base"
                    >
                      <option value="" class="text-slate-500">Sélectionnez une ville</option>
                      <option *ngFor="let ville of filterOptions.villes" [value]="ville.id" class="text-slate-900">
                  {{ ville.name }}
                </option>
              </select>
                  </label>
                </div>
            </div>

            <!-- Groupe -->
              <div class="group relative">
                <div class="absolute inset-0 bg-gradient-to-r from-blue-500/5 to-blue-500/5 rounded-2xl transition-opacity group-hover:opacity-75"></div>
                <div class="relative bg-white/70 backdrop-blur-sm border border-slate-200/50 rounded-2xl p-6 transition-all duration-300 group-hover:shadow-xl group-hover:shadow-blue-500/10">
                  <label class="block space-y-4">
                    <div class="flex items-center gap-4">
                      <div class="w-10 h-10 bg-white border-2 border-slate-200 rounded-xl flex items-center justify-center shadow-lg">
                        <mat-icon class="text-slate-600 text-lg">group</mat-icon>
                      </div>
                      <div class="flex-1">
                        <div class="flex items-center gap-2">
                          <span class="text-lg font-semibold text-slate-900">Groupe</span>
                          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">Requis</span>
                        </div>
                        <p class="text-sm text-slate-500 mt-1">Groupe de classe des étudiants</p>
                      </div>
                </div>
                    <select 
                      formControlName="group_id" 
                      class="w-full px-4 py-4 text-slate-900 bg-white border-2 border-slate-200 rounded-xl transition-all duration-200 focus:outline-none focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 hover:border-slate-300 text-base"
                    >
                      <option value="" class="text-slate-500">Sélectionnez un groupe</option>
                      <option *ngFor="let group of filterOptions.groups" [value]="group.id" class="text-slate-900">
                  {{ group.title }}
                </option>
              </select>
                  </label>
                </div>
            </div>

            <!-- Option -->
              <div class="group relative">
                <div class="absolute inset-0 bg-gradient-to-r from-blue-500/5 to-blue-500/5 rounded-2xl transition-opacity group-hover:opacity-75"></div>
                <div class="relative bg-white/70 backdrop-blur-sm border border-slate-200/50 rounded-2xl p-6 transition-all duration-300 group-hover:shadow-xl group-hover:shadow-blue-500/10">
                  <label class="block space-y-4">
                    <div class="flex items-center gap-4">
                      <div class="w-10 h-10 bg-white border-2 border-slate-200 rounded-xl flex items-center justify-center shadow-lg">
                        <mat-icon class="text-slate-600 text-lg">category</mat-icon>
                      </div>
                      <div class="flex-1">
                        <div class="flex items-center gap-2">
                          <span class="text-lg font-semibold text-slate-900">Option</span>
                          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Optionnel</span>
                        </div>
                        <p class="text-sm text-slate-500 mt-1">Spécialisation ou filière (si applicable)</p>
                      </div>
                </div>
                    <select 
                      formControlName="option_id" 
                      class="w-full px-4 py-4 text-slate-900 bg-white border-2 border-slate-200 rounded-xl transition-all duration-200 focus:outline-none focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 hover:border-slate-300 text-base"
                    >
                      <option value="" class="text-slate-500">Aucune option (optionnel)</option>
                      <option *ngFor="let option of filterOptions.options" [value]="option.id" class="text-slate-900">
                  {{ option.name }}
                </option>
              </select>
                  </label>
                </div>
            </div>

            <!-- Mode de traitement des doublons -->
              <div class="lg:col-span-2 group relative">
                <div class="absolute inset-0 bg-gradient-to-r from-blue-500/5 to-blue-500/5 rounded-2xl transition-opacity group-hover:opacity-75"></div>
                <div class="relative bg-white/70 backdrop-blur-sm border border-slate-200/50 rounded-2xl p-6 transition-all duration-300 group-hover:shadow-xl group-hover:shadow-blue-500/10">
                  <label class="block space-y-4">
                    <div class="flex items-center gap-4">
                      <div class="w-10 h-10 bg-white border-2 border-slate-200 rounded-xl flex items-center justify-center shadow-lg">
                        <mat-icon class="text-slate-600 text-lg">tune</mat-icon>
                      </div>
                      <div class="flex-1">
                        <div class="flex items-center gap-2">
                          <span class="text-lg font-semibold text-slate-900">Gestion des Doublons</span>
                          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">Avancé</span>
                        </div>
                        <p class="text-sm text-slate-500 mt-1">Stratégie en cas d'étudiant existant dans le système</p>
                      </div>
                </div>
                    <select 
                      [(ngModel)]="importOptions.duplicateMode"
                      class="w-full px-4 py-4 text-slate-900 bg-white border-2 border-slate-200 rounded-xl transition-all duration-200 focus:outline-none focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 hover:border-slate-300 text-base"
                    >
                      <option value="update" class="text-slate-900">🔄 Mettre à jour les informations existantes</option>
                      <option value="skip" class="text-slate-900">⏭️ Ignorer les doublons</option>
                      <option value="error" class="text-slate-900">❌ Signaler comme erreur</option>
              </select>
                  </label>
                </div>
              </div>
            </div>

            <!-- Confirmation Professionnelle -->
            <div class="mt-10 relative">
              <div class="absolute inset-0 bg-gradient-to-r from-emerald-500/10 to-green-500/10 rounded-2xl"></div>
              <div class="relative bg-gradient-to-r from-emerald-50/80 to-green-50/80 border border-emerald-200/50 rounded-2xl p-8">
                <div class="flex items-center gap-6">
                  <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-green-600 rounded-xl flex items-center justify-center shadow-lg">
                      <mat-icon class="text-white text-xl">auto_awesome</mat-icon>
                    </div>
                  </div>
                  <div class="flex-1">
                    <h5 class="text-lg font-semibold text-slate-900 mb-2">
                      Configuration Automatique Active
                    </h5>
                    <p class="text-slate-600">
                      Les paramètres définis ci-dessus seront automatiquement appliqués à tous les étudiants importés
                    </p>
                  </div>
                  <div class="flex items-center gap-2 text-sm text-emerald-700">
                    <mat-icon class="text-emerald-500">check_circle</mat-icon>
                    <span class="font-medium">Prêt</span>
            </div>
          </div>
              </div>
            </div>
          </form>
          </div>
      </div>
    </div>


    <!-- Zone d'Upload Ultra-Moderne avec Effets Avancés -->
    <div class="relative group">
      <!-- Animated Background -->
      <div class="absolute inset-0 bg-gradient-to-br from-blue-50/50 via-indigo-50/30 to-purple-50/20 rounded-3xl opacity-0 group-hover:opacity-100 transition-opacity duration-1000"></div>
      
            <div class="relative bg-white rounded-2xl border border-gray-200 shadow-md overflow-hidden">
        <!-- Header Élégant -->
        <div class="relative bg-gradient-to-r from-slate-50 to-blue-50/50 border-b border-slate-200/50 px-8 py-6">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-6">
              <div class="relative">
                <div class="w-14 h-14 bg-blue-600 rounded-2xl flex items-center justify-center shadow-lg">
                  <mat-icon class="text-white text-2xl">cloud_upload</mat-icon>
                </div>
                <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-green-500 rounded-full border-2 border-white flex items-center justify-center">
                  <mat-icon class="text-white text-xs">add</mat-icon>
                </div>
              </div>
              <div class="space-y-2">
                <h2 class="text-2xl lg:text-3xl font-extralight text-slate-900 tracking-tight">
                  Sélection du Fichier
                </h2>
                <div class="flex items-center gap-4 text-sm text-slate-500">
                  <span class="flex items-center gap-2">
                    <mat-icon class="text-blue-500 text-base">description</mat-icon>
                    Format CSV uniquement
                  </span>
                  <span class="flex items-center gap-2">
                    <mat-icon class="text-emerald-500 text-base">verified</mat-icon>
                    Validation automatique
                  </span>
                </div>
              </div>
          </div>
          
            <!-- Indicateur de progression -->
          <div class="text-center" *ngIf="uploadProgress > 0">
              <div class="w-16 h-16 bg-green-500 rounded-xl flex items-center justify-center shadow-lg mx-auto">
                <div class="text-lg font-bold text-white">{{ uploadProgress }}%</div>
              </div>
              <div class="text-sm text-slate-600 font-medium mt-3">
                Traitement en cours
              </div>
          </div>
        </div>
      </div>

      <!-- Contenu principal -->
      <div class="p-6">
        <!-- Messages d'état -->
        <div *ngIf="loading" class="mb-4 flex items-center gap-3 bg-gray-50 border border-gray-200 rounded-md p-3">
          <mat-spinner diameter="20"></mat-spinner>
          <span class="text-gray-700">{{ loadingMessage || 'Traitement en cours...' }}</span>
        </div>

        <div *ngIf="error" class="mb-4 flex items-center gap-3 bg-red-50 border border-red-200 rounded-md p-3">
          <mat-icon class="text-red-500">error</mat-icon>
          <span class="text-red-700">{{ error }}</span>
        </div>

        <div *ngIf="success" class="mb-4 flex items-center gap-3 bg-green-50 border border-green-200 rounded-md p-3">
          <mat-icon class="text-green-500">check_circle</mat-icon>
          <span class="text-green-700">{{ success }}</span>
        </div>

        <!-- Zone de Dépôt -->
        <div class="p-8 lg:p-12">
          <div 
            class="border-2 border-dashed border-gray-200 rounded-xl p-10 text-center transition-colors duration-200 hover:border-gray-300 hover:bg-gray-50"
            [class.border-blue-500]="isDragOver"
            [class.bg-blue-50]="isDragOver"
            (dragover)="onDragOver($event)"
            (dragleave)="onDragLeave($event)"
            (drop)="onFileDropped($event)"
          >
              <div class="space-y-8">
                <!-- Icône centrale -->
              <div class="flex justify-center">
                  <div class="w-20 h-20 bg-gray-800 rounded-xl flex items-center justify-center">
                    <mat-icon class="text-white text-4xl">cloud_upload</mat-icon>
                  </div>
                </div>
                
                <!-- Contenu textuel -->
                <div class="space-y-4">
                  <div class="space-y-2">
                    <h3 class="text-2xl lg:text-3xl font-light text-gray-900">
                      Déposez votre fichier (CSV, TXT, Excel)
                    </h3>
                    <p class="text-gray-500 text-lg">
                      ou cliquez pour parcourir vos fichiers
                    </p>
              </div>
              
                  <!-- Spécifications techniques -->
                  <div class="inline-flex items-center gap-8 text-sm text-gray-400">
                    <div class="flex items-center gap-2">
                      <div class="w-2 h-2 bg-blue-400 rounded-full"></div>
                      <span>CSV, TXT, Excel</span>
                    </div>
                    <div class="flex items-center gap-2">
                      <div class="w-2 h-2 bg-emerald-400 rounded-full"></div>
                      <span>Max 10 MB</span>
                    </div>
                    <div class="flex items-center gap-2">
                      <div class="w-2 h-2 bg-purple-400 rounded-full"></div>
                      <span>Validation auto</span>
                    </div>
                  </div>
              </div>
              
                <!-- Bouton -->
              <div>
                <input 
                  type="file" 
                  #fileInput 
                  (change)="onFileSelected($event)"
                  accept=".csv,.txt,.xlsx,.xls"
                  class="hidden"
                >
                <button 
                  (click)="fileInput.click()"
                  [disabled]="loading"
                  class="inline-flex items-center justify-center px-6 py-3 text-base font-medium text-white bg-gray-900 rounded-lg hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-400 disabled:opacity-50"
                >
                  <mat-icon class="mr-3 text-xl">folder_open</mat-icon>
                  <span>Sélectionner un fichier (CSV, TXT, Excel)</span>
                </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Fichier Sélectionné Premium -->
        <div *ngIf="selectedFile" class="relative">
          <div class="bg-white/90 backdrop-blur-sm border border-emerald-200/50 rounded-3xl p-8 shadow-xl shadow-emerald-500/5 transition-all duration-500 hover:shadow-2xl">
            <!-- Header du fichier -->
            <div class="flex items-start justify-between mb-8">
              <div class="flex items-center gap-6">
                <div class="relative">
                  <div class="w-16 h-16 bg-gradient-to-br from-emerald-500 to-green-600 rounded-2xl flex items-center justify-center shadow-xl">
                    <mat-icon class="text-white text-2xl">description</mat-icon>
                  </div>
                  <!-- Badge de validation -->
                  <div class="absolute -top-2 -right-2 w-8 h-8 bg-blue-500 rounded-full border-3 border-white flex items-center justify-center">
                    <mat-icon class="text-white text-sm">verified</mat-icon>
                  </div>
                </div>
                <div class="space-y-2">
                  <h4 class="text-xl font-semibold text-slate-900 tracking-tight">{{ selectedFile.name }}</h4>
                  <div class="flex items-center gap-4 text-sm text-slate-500">
                    <span class="flex items-center gap-2">
                      <mat-icon class="text-emerald-500 text-base">storage</mat-icon>
                    {{ formatFileSize(selectedFile.size) }}
                    </span>
                    <span class="flex items-center gap-2">
                      <mat-icon class="text-blue-500 text-base">schedule</mat-icon>
                      Maintenant
                    </span>
                  </div>
                  <!-- Status badge -->
                  <div class="inline-flex items-center gap-2 px-3 py-1 bg-emerald-100 text-emerald-800 rounded-full text-xs font-medium">
                    <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
                    Fichier validé
                  </div>
                </div>
              </div>
              
              <!-- Bouton de suppression élégant -->
              <button 
                (click)="removeSelectedFile()"
                [disabled]="loading"
                class="group relative w-12 h-12 text-slate-400 hover:text-red-500 bg-white hover:bg-red-50 rounded-2xl border-2 border-slate-200 hover:border-red-200 transition-all duration-300 flex items-center justify-center hover:scale-105 focus:outline-none focus:ring-4 focus:ring-red-500/20"
              >
                <mat-icon class="transition-transform group-hover:scale-110">close</mat-icon>
              </button>
            </div>
            
            <!-- Aperçu des données supprimé : l'éditeur devient la vue principale -->

        <!-- Espacement entre les sections -->
        <div class="py-6"></div>

        <!-- Résultats de validation -->
        <div *ngIf="validationResults" class="mb-8">
          <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <!-- Header -->
            <div class="bg-purple-50 border-b border-purple-100 p-6">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-purple-600 rounded-xl flex items-center justify-center">
                  <mat-icon class="text-white text-xl">verified</mat-icon>
                </div>
                <div>
                  <h3 class="text-2xl font-light text-gray-900">Résultats de la Validation</h3>
                  <p class="text-gray-500 mt-1">Analyse préalable du fichier</p>
                </div>
              </div>
            </div>
            
            <!-- Content -->
            <div class="p-6">
              <!-- Statut de validation -->
              <div class="mb-6">
                <div class="flex items-center gap-3 mb-4">
                  <div class="w-8 h-8 rounded-full flex items-center justify-center" 
                       [class]="validationResults.valid ? 'bg-green-100' : 'bg-red-100'">
                    <mat-icon [class]="validationResults.valid ? 'text-green-600' : 'text-red-600'">
                      {{ validationResults.valid ? 'check_circle' : 'error' }}
                    </mat-icon>
                  </div>
                  <div>
                    <h4 class="text-lg font-medium text-gray-900">
                      {{ validationResults.valid ? 'Fichier Valide' : 'Fichier Invalide' }}
                    </h4>
                    <p class="text-sm text-gray-600">
                      {{ validationResults.valid ? 'Prêt pour l\'importation' : 'Corrections nécessaires' }}
                    </p>
                  </div>
                </div>
              </div>

              <!-- Statistiques de validation -->
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white border border-gray-100 rounded-xl p-4 text-center">
                  <div class="text-2xl font-light text-blue-600 mb-1">{{ validationResults.totalRows }}</div>
                  <div class="text-sm text-gray-600">Total lignes</div>
                </div>
                <div class="bg-white border border-gray-100 rounded-xl p-4 text-center">
                  <div class="text-2xl font-light text-green-500 mb-1">{{ validationResults.validRows }}</div>
                  <div class="text-sm text-gray-600">Lignes valides</div>
                </div>
                <div class="bg-white border border-gray-100 rounded-xl p-4 text-center">
                  <div class="text-2xl font-light text-red-500 mb-1">{{ validationResults.errorRows }}</div>
                  <div class="text-sm text-gray-600">Erreurs</div>
                </div>
                <div class="bg-white border border-gray-100 rounded-xl p-4 text-center">
                  <div class="text-2xl font-light text-orange-500 mb-1">{{ validationResults.warnings }}</div>
                  <div class="text-sm text-gray-600">Avertissements</div>
                </div>
              </div>

              <!-- Informations sur le fichier -->
              <div class="bg-gray-50 rounded-xl p-4 mb-6">
                <h5 class="font-medium text-gray-900 mb-3">Informations sur le fichier</h5>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                  <div>
                    <span class="text-gray-600">Format détecté :</span>
                    <span class="font-medium text-gray-900 ml-2">{{ validationResults.summary.detectedFormat }}</span>
                  </div>
                  <div>
                    <span class="text-gray-600">En-têtes :</span>
                    <span class="font-medium text-gray-900 ml-2">{{ validationResults.summary.hasHeaders ? 'Oui' : 'Non' }}</span>
                  </div>
                  <div class="md:col-span-2">
                    <span class="text-gray-600">Colonnes :</span>
                    <span class="font-medium text-gray-900 ml-2">{{ validationResults.summary.columns.join(', ') }}</span>
                  </div>
                </div>
              </div>

              <!-- Erreurs de validation -->
              <div *ngIf="validationResults.errors && validationResults.errors.length > 0" class="bg-red-50 rounded-xl p-6 border border-red-100 mb-6">
                <h5 class="font-medium text-red-800 mb-4 flex items-center gap-2">
                  <mat-icon class="text-red-600">error</mat-icon>
                  Erreurs de validation ({{ validationResults.errors.length }})
                </h5>
                <div class="space-y-3">
                  <div *ngFor="let error of validationResults.errors" class="bg-white rounded-lg p-4 border border-red-200 shadow-sm">
                    <div class="flex items-start gap-3">
                      <div class="w-6 h-6 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                        <span class="text-xs font-medium text-red-600">{{ error.line }}</span>
                      </div>
                      <div class="flex-1">
                        <div class="text-sm font-medium text-red-800 mb-1">Ligne {{ error.line }}</div>
                        <div class="text-sm text-red-700 mb-2">{{ error.message }}</div>
                        <div *ngIf="hasObjectKeys(error.suggestions)" class="bg-red-25 rounded-lg p-3 border border-red-100">
                          <div class="text-xs font-medium text-red-600 mb-2">Suggestions :</div>
                          <div *ngFor="let suggestion of error.suggestions | keyvalue" class="text-xs text-red-700 mb-1">
                            <span class="font-medium">{{ suggestion.key }}:</span> {{ suggestion.value }}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Avertissements -->
              <div *ngIf="validationResults.warningsList && validationResults.warningsList.length > 0" class="bg-orange-50 rounded-xl p-6 border border-orange-100">
                <h5 class="font-medium text-orange-800 mb-4 flex items-center gap-2">
                  <mat-icon class="text-orange-600">warning</mat-icon>
                  Avertissements ({{ validationResults.warningsList.length }})
                </h5>
                <div class="space-y-3">
                  <div *ngFor="let warning of validationResults.warningsList" class="bg-white rounded-lg p-4 border border-orange-200 shadow-sm">
                    <div class="flex items-start gap-3">
                      <div class="w-6 h-6 bg-orange-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                        <span class="text-xs font-medium text-orange-600">{{ warning.line }}</span>
                      </div>
                      <div class="flex-1">
                        <div class="text-sm font-medium text-orange-800 mb-1">Ligne {{ warning.line }}</div>
                        <div class="text-sm text-orange-700">{{ warning.message }}</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Éditeur de fichier comme Excel -->
        <div *ngIf="showFileEditor" class="mb-8">
          <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <!-- Header -->
            <div class="bg-green-50 border-b border-green-100 p-6">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                  <div class="w-12 h-12 bg-green-600 rounded-xl flex items-center justify-center">
                    <mat-icon class="text-white text-xl">edit</mat-icon>
                  </div>
                  <div>
                    <h3 class="text-2xl font-light text-gray-900">Éditeur de Fichier</h3>
                    <p class="text-gray-500 mt-1">Corrigez les erreurs directement dans le fichier</p>
                  </div>
                </div>
                <div class="flex gap-3">
                  <button 
                    (click)="revalidateEditedData()"
                    [disabled]="isValidating"
                    class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-purple-600 border border-transparent rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500"
                  >
                    <mat-icon class="mr-2 text-lg">verified</mat-icon>
                    Revalider
                  </button>
                  <button 
                    (click)="saveCorrectedFile()"
                    class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-green-600 border border-transparent rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500"
                  >
                    <mat-icon class="mr-2 text-lg">save</mat-icon>
                    Sauvegarder
                  </button>
                  <button 
                    (click)="startImport()"
                    [disabled]="isValidating"
                    class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-emerald-600 border border-transparent rounded-lg hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                  >
                    <mat-icon class="mr-2 text-lg">rocket_launch</mat-icon>
                    Importer le fichier corrigé
                  </button>
                  <button 
                    (click)="closeFileEditor()"
                    class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500"
                  >
                    <mat-icon class="mr-2 text-lg">close</mat-icon>
                    Fermer
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Content -->
            <div class="p-6">
              <!-- Instructions -->
              <div class="bg-blue-50 rounded-xl p-4 mb-6 border border-blue-100">
                <div class="flex items-start gap-3">
                  <mat-icon class="text-blue-600 mt-0.5">info</mat-icon>
                  <div>
                    <h4 class="font-medium text-blue-800 mb-2">Comment utiliser l'éditeur</h4>
                    <ul class="text-sm text-blue-700 space-y-1">
                      <li>• Cliquez sur une cellule pour l'éditer</li>
                      <li>• Les suggestions apparaissent automatiquement pour les relations</li>
                      <li>• Les cellules avec erreurs sont surlignées en rouge</li>
                      <li>• Sauvegardez le fichier corrigé une fois terminé</li>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Bouton de test temporaire -->
              <div class="bg-yellow-50 rounded-xl p-4 mb-6 border border-yellow-100">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <mat-icon class="text-yellow-600">bug_report</mat-icon>
                    <div>
                      <h4 class="font-medium text-yellow-800">Diagnostic des suggestions</h4>
                      <p class="text-sm text-yellow-700">Bouton temporaire pour tester le système de suggestions</p>
                    </div>
                  </div>
                  <button 
                    (click)="testSuggestions()"
                    class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 text-sm font-medium">
                    Tester les suggestions
                  </button>
                </div>
              </div>

              <!-- Tableau éditable -->
              <div class="overflow-x-auto border border-gray-200 rounded-xl">
                <table class="min-w-full divide-y divide-gray-200">
                  <!-- En-têtes -->
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">
                        #
                      </th>
                      <th *ngFor="let header of editableHeaders" 
                          class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-32">
                        {{ header }}
                        <div class="text-xs text-gray-400 mt-1">
                          {{ ['matricule', 'first_name', 'last_name', 'email', 'password'].includes(header) ? 'Obligatoire' : 'Optionnel' }}
                        </div>
                      </th>
                    </tr>
                  </thead>
                  
                  <!-- Données -->
                  <tbody class="bg-white divide-y divide-gray-200">
                    <tr *ngFor="let row of editableData; let rowIndex = index" 
                        class="hover:bg-gray-50">
                      <!-- Numéro de ligne -->
                      <td class="px-4 py-3 text-sm text-gray-500 bg-gray-50 font-medium">
                        {{ rowIndex + 1 }}
                      </td>
                      
                      <!-- Cellules -->
                      <td *ngFor="let cell of row; let colIndex = index" 
                          class="px-4 py-3 text-sm"
                          [class]="getCellClass(rowIndex, colIndex)"
                          (click)="startEditingCell(rowIndex, colIndex)">
                        
                        <!-- Cellule en édition -->
                        <div *ngIf="editingCell?.row === rowIndex && editingCell?.col === colIndex" 
                             class="relative">
                          <input 
                            type="text" 
                            [value]="cell"
                            (blur)="finishEditingCell()"
                            (keydown)="onKeyDown($event, rowIndex, colIndex)"
                            (input)="onEditInput(rowIndex, colIndex, $event.target.value)"
                            class="w-full px-2 py-1 border border-blue-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                            autofocus>
                          
                          <!-- Suggestions -->
                          <div *ngIf="cellSuggestions.length > 0" 
                               class="absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-lg shadow-lg z-20 max-h-48 overflow-y-auto">
                            <div class="p-2 text-xs text-gray-500 border-b border-gray-100">
                              {{ cellSuggestions.length }} suggestion(s) trouvée(s)
                            </div>
                            <div *ngFor="let suggestion of cellSuggestions; trackBy: trackSuggestion"
                                 (click)="applySuggestion(rowIndex, colIndex, suggestion)"
                                 class="px-3 py-2 hover:bg-blue-50 cursor-pointer text-sm border-b border-gray-100 last:border-b-0 transition-colors">
                              <div class="flex items-center justify-between">
                                <div class="flex-1">
                                  <div class="font-medium text-gray-900">
                                    {{ suggestion.name || suggestion.title }}
                                  </div>
                                  <div class="text-xs text-gray-500">
                                    ID: {{ suggestion.id }}
                                  </div>
                                </div>
                                <div class="text-xs text-blue-600 font-medium">
                                  Cliquer pour sélectionner
                                </div>
                              </div>
                            </div>
                            <div *ngIf="cellSuggestions.length === 0" class="px-3 py-4 text-sm text-gray-500 text-center">
                              <mat-icon class="text-gray-400 text-base mb-1">search_off</mat-icon>
                              <div>Aucune suggestion trouvée</div>
                              <div class="text-xs text-gray-400 mt-1">Essayez un autre terme de recherche</div>
                            </div>
                          </div>
                        </div>
                        
                        <!-- Cellule normale -->
                        <div *ngIf="!(editingCell?.row === rowIndex && editingCell?.col === colIndex)" 
                             class="cursor-pointer hover:bg-gray-100 px-2 py-1 rounded">
                          {{ cell || '' }}
                        </div>
                        
                        <!-- Indicateur d'erreur -->
                        <div *ngIf="!validateCell(rowIndex, colIndex).valid" 
                             class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full"></div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- Légende -->
              <div class="mt-6 flex items-center gap-6 text-sm">
                <div class="flex items-center gap-2">
                  <div class="w-4 h-4 bg-red-100 border border-red-300 rounded"></div>
                  <span class="text-gray-600">Cellule avec erreur</span>
                </div>
                <div class="flex items-center gap-2">
                  <div class="w-4 h-4 bg-green-100 border border-green-300 rounded"></div>
                  <span class="text-gray-600">Cellule valide</span>
                </div>
                <div class="flex items-center gap-2">
                  <div class="w-4 h-4 bg-blue-100 border border-blue-300 rounded"></div>
                  <span class="text-gray-600">Cellule en édition</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Résultats d'importation -->
        <div *ngIf="importResults" class="mb-8">
          <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <!-- Header -->
            <div class="bg-blue-50 border-b border-blue-100 p-6">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center">
                  <mat-icon class="text-white text-xl">analytics</mat-icon>
                </div>
                <div>
                  <h3 class="text-2xl font-light text-gray-900">Résultats de l'Importation</h3>
                  <p class="text-gray-500 mt-1">Statistiques d'importation</p>
                </div>
              </div>
            </div>
            
            <!-- Content -->
            <div class="p-6">

            <!-- Statistiques d'importation -->
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white border border-gray-100 rounded-xl p-4 text-center">
                  <div class="text-2xl font-light text-blue-600 mb-1">{{ importResults.total || 0 }}</div>
                  <div class="text-sm text-gray-600">Total traités</div>
                </div>
                <div class="bg-white border border-gray-100 rounded-xl p-4 text-center">
                  <div class="text-2xl font-light text-green-500 mb-1">{{ importResults.created || 0 }}</div>
                  <div class="text-sm text-gray-600">Créés</div>
              </div>
                <div class="bg-white border border-gray-100 rounded-xl p-4 text-center">
                  <div class="text-2xl font-light text-orange-500 mb-1">{{ importResults.updated || 0 }}</div>
                  <div class="text-sm text-gray-600">Mis à jour</div>
              </div>
                <div class="bg-white border border-gray-100 rounded-xl p-4 text-center">
                  <div class="text-2xl font-light text-red-500 mb-1">{{ importResults.errors || 0 }}</div>
                  <div class="text-sm text-gray-600">Erreurs</div>
              </div>
            </div>

            <!-- Message principal -->
              <div class="bg-blue-50 rounded-xl p-4 text-center mb-6">
                <div class="font-medium text-gray-900">{{ importResults.message }}</div>
            </div>

            <!-- Détails des erreurs avec suggestions (si présentes) -->
              <div *ngIf="importResults.errorDetails && importResults.errorDetails.length > 0" class="bg-red-50 rounded-xl p-6 border border-red-100">
                <h4 class="font-medium text-gray-900 mb-4 flex items-center gap-3">
                  <mat-icon class="text-red-500">error</mat-icon>
                  Détails des erreurs avec suggestions de correction
                </h4>
                <div class="space-y-4 max-h-60 overflow-y-auto">
                  <div *ngFor="let errorDetail of importResults.errorDetails" class="bg-white rounded-lg p-4 border border-red-200 shadow-sm">
                    <div class="flex items-start gap-3">
                      <div class="flex-shrink-0 w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
                        <span class="text-red-600 font-bold text-sm">{{ errorDetail.line }}</span>
                      </div>
                      <div class="flex-1">
                        <div class="text-sm font-medium text-red-800 mb-2">
                          Ligne {{ errorDetail.line }}: {{ errorDetail.message }}
                        </div>
                        
                        <!-- Suggestions -->
                        <div *ngIf="hasObjectKeys(errorDetail.suggestions)" class="mt-3">
                          <div class="text-xs font-medium text-blue-700 mb-2 flex items-center gap-2">
                            <mat-icon class="text-blue-500 text-sm">lightbulb</mat-icon>
                            Suggestions de correction:
                          </div>
                          <div class="space-y-2">
                            <div *ngFor="let suggestion of errorDetail.suggestions | keyvalue" class="bg-blue-50 rounded-lg p-3 border border-blue-200">
                              <div class="text-xs font-medium text-blue-800 mb-1">{{ suggestion.key }}:</div>
                              <div class="text-sm text-blue-700">{{ suggestion.value }}</div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Actions Ultra-Professionnelles -->
        <div class="relative mt-12">
          <div class="absolute inset-0 bg-gradient-to-r from-slate-50/50 to-blue-50/30 rounded-2xl"></div>
          <div class="relative border-t border-slate-200/50 pt-10">
            <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center gap-6">
              <!-- Action secondaire -->
          <button 
            type="button"
            (click)="goBack()"
            [disabled]="loading"
                class="group inline-flex items-center justify-center px-8 py-4 text-base font-semibold text-slate-700 transition-all duration-300 bg-white border-2 border-slate-200 rounded-2xl hover:bg-slate-50 hover:border-slate-300 hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-slate-500/20 disabled:opacity-50"
          >
                <mat-icon class="mr-3 text-xl transition-transform group-hover:-translate-x-1">arrow_back</mat-icon>
                <span>Retour à la liste</span>
          </button>

              <!-- Actions principales -->
              <div class="flex flex-col sm:flex-row gap-4">
            <button 
              type="button"
              (click)="resetImport()"
              [disabled]="loading"
                  class="group inline-flex items-center justify-center px-8 py-4 text-base font-semibold text-orange-700 transition-all duration-300 bg-white border-2 border-orange-200 rounded-2xl hover:bg-orange-50 hover:border-orange-300 hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-orange-500/20 disabled:opacity-50"
            >
                  <mat-icon class="mr-3 text-xl transition-transform group-hover:rotate-180">refresh</mat-icon>
                  <span>Réinitialiser</span>
            </button>

                <!-- Bouton de validation -->
            <button 
              type="button"
              (click)="validateFile()"
              [disabled]="!selectedFile || loading || isValidating"
              class="group relative inline-flex items-center justify-center px-8 py-4 text-base font-semibold text-white bg-purple-600 border border-transparent rounded-xl hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200"
            >
              <mat-spinner *ngIf="isValidating" diameter="20" class="text-white mr-3"></mat-spinner>
              <mat-icon *ngIf="!isValidating" class="text-xl mr-3">verified</mat-icon>
              <span>
                {{ isValidating ? 'Validation en cours...' : 'Valider le fichier' }}
              </span>
            </button>

                <!-- Bouton principal optimisé -->
            <button 
              type="button"
              (click)="startImport()"
              [disabled]="!selectedFile || loading || !validationCompleted || !validationResults?.valid"
              class="group relative inline-flex items-center justify-center px-10 py-4 text-base font-semibold text-white bg-green-600 border border-transparent rounded-xl hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200"
            >
              <mat-spinner *ngIf="loading" diameter="20" class="text-white mr-3"></mat-spinner>
              <mat-icon *ngIf="!loading" class="text-xl mr-3">rocket_launch</mat-icon>
              <span>
                {{ loading ? 'Importation en cours...' : 'Lancer l\'Importation' }}
              </span>
            </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Espacement en bas des boutons -->
    <div class="py-8"></div>

    <!-- Espacement -->
    <div class="py-8"></div>

    <!-- CSV guide hidden -->
    <!-- The detailed CSV guide content has been removed for now to keep the template concise. -->
  </div>
</div>