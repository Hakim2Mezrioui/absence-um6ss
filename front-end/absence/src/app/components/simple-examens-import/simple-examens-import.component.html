<div class="min-h-screen flex flex-col bg-slate-50 overflow-hidden">
  <!-- Compact Header Section -->
  <div class="flex-shrink-0 bg-white border-b border-slate-200 shadow-sm">
    <div class="max-w-full px-6 py-4">
      <div class="flex items-center justify-between gap-4">
        <div class="flex items-center gap-4">
          <h1 class="text-2xl font-semibold text-slate-900">Importation des examens</h1>
          <span *ngIf="tableRows.length" class="text-sm text-slate-600">{{ tableRows.length }} ligne(s)</span>
        </div>
        <div class="flex flex-wrap gap-2">
          <button type="button"
                  (click)="downloadTemplate()"
                  class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-slate-300 bg-white text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors">
            <span class="material-icons text-base">download</span>
            Modèle
          </button>
          <label class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-medium cursor-pointer hover:bg-blue-700 transition-colors">
            <span class="material-icons text-base">upload_file</span>
            {{ fileName ? 'Importer un nouveau fichier' : 'Importer' }}
            <input type="file" accept=".xlsx,.xls" class="hidden" (change)="onFileSelected($event)" />
          </label>
        </div>
      </div>

      <!-- Compact Status Bar -->
      <div *ngIf="tableRows.length" class="mt-3 flex items-center gap-6 text-sm">
        <div class="flex items-center gap-2">
          <div class="w-3 h-3 rounded-full" [class.bg-green-500]="!hasInvalidCells()" [class.bg-red-500]="hasInvalidCells()"></div>
          <span [class.text-green-600]="!hasInvalidCells()" [class.text-red-600]="hasInvalidCells()">
            {{ hasInvalidCells() ? getInvalidCellsCount() + ' erreur(s)' : 'Données valides' }}
          </span>
        </div>
        <div class="flex items-center gap-4 text-xs text-slate-500">
          <span>{{ getValidCellsCount() }} valides</span>
          <span>{{ getTotalCellsCount() }} total</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Messages Compacts -->
  <div *ngIf="errorMessage || successMessage || isProcessing" class="flex-shrink-0 px-6 py-2 bg-white border-b border-slate-200">
    <div *ngIf="errorMessage" class="flex items-center gap-2 text-sm text-red-700 bg-red-50 px-3 py-2 rounded">
      <span class="material-icons text-base">error_outline</span>
      <span>{{ errorMessage }}</span>
    </div>
    <div *ngIf="successMessage" class="flex items-center gap-2 text-sm text-green-700 bg-green-50 px-3 py-2 rounded">
      <span class="material-icons text-base">check_circle_outline</span>
      <span>{{ successMessage }}</span>
    </div>
    <div *ngIf="isProcessing" class="flex items-center gap-2 text-sm text-blue-700 bg-blue-50 px-3 py-2 rounded">
      <span class="material-icons text-base animate-spin">refresh</span>
      <span>Traitement en cours...</span>
    </div>
  </div>

  <!-- Empty State avec drag & drop -->
  <div *ngIf="!tableRows.length && !isProcessing" class="flex-1 flex items-center justify-center px-6">
    <div
      class="w-full max-w-3xl rounded-2xl border-2 border-dashed transition-all p-10 bg-white cursor-pointer"
      [class.border-blue-500]="isDragging"
      [class.bg-blue-50]="isDragging"
      (dragover)="onDragOver($event)"
      (dragleave)="onDragLeave($event)"
      (drop)="onDrop($event)"
      (click)="onZoneClick(fileInput)"
    >
      <div class="flex flex-col items-center gap-4 text-center text-slate-600">
        <span class="material-icons text-5xl text-indigo-500">cloud_upload</span>
        <div class="text-lg font-semibold text-slate-900">Glissez-déposez votre fichier Excel ici</div>
        <p class="text-sm text-slate-500">ou cliquez pour sélectionner un fichier .xlsx/.xls</p>
        <input #fileInput type="file" accept=".xlsx,.xls" class="hidden" (change)="onFileSelected($event)" />
      </div>
    </div>
  </div>

  <!-- Data Table - Full Height -->
  <div *ngIf="tableRows.length" class="flex-1 overflow-hidden">
    <div class="h-full overflow-auto table-scroll">
      <table class="w-full border-collapse">
        <thead class="sticky top-0 z-20 bg-slate-100 border-b-2 border-slate-300">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-bold text-slate-700 uppercase border-r border-slate-300" style="min-width: 60px; white-space: nowrap;">#</th>
            <th *ngFor="let header of tableHeaders" 
                class="px-4 py-3 text-left text-xs font-bold text-slate-700 uppercase border-r border-slate-300"
                [class.bg-red-100]="isColumnInvalid(header)"
                [style.min-width]="getMinColumnWidth(header)"
                style="white-space: nowrap;">
              <div class="flex items-center gap-2">
                <span>{{ getHeaderDisplayName(header) }}</span>
                <span *ngIf="relationHeaders.includes(header)" class="text-red-500">*</span>
              </div>
            </th>
          </tr>
        </thead>
        <tbody>
          <!-- Each row with dedicated space for suggestions -->
          <ng-container *ngFor="let row of tableRows; trackBy: trackByRow; let i = index">
            <!-- Data Row -->
            <tr class="bg-white border-b border-slate-200 hover:bg-slate-50"
                [class.bg-red-50]="isRowInvalid(i)"
                [class.border-l-4]="isRowInvalid(i)"
                [class.border-red-500]="isRowInvalid(i)">
              <!-- Row Number -->
              <td class="px-4 py-4 text-center font-semibold text-slate-600 border-r border-slate-200 bg-slate-50" style="min-width: 60px;">
                {{ i + 1 }}
              </td>
              
              <!-- Data Cells -->
              <td *ngFor="let header of tableHeaders" 
                  class="px-4 py-4 border-r border-slate-200 align-top"
                  [class.bg-red-50]="isCellInvalid(i, header)"
                  [style.min-width]="getMinColumnWidth(header)">
                <div class="space-y-2">
                  <!-- Input Field -->
                  <input type="text"
                         [value]="row[header]"
                         (input)="updateCell(i, header, $any($event.target).value)"
                         [placeholder]="getPlaceholder(header)"
                         class="w-full px-3 py-2 text-sm border-2 rounded-lg focus:outline-none focus:ring-2 transition-all"
                         [class.border-red-400]="isCellInvalid(i, header)"
                         [class.bg-red-50]="isCellInvalid(i, header)"
                         [class.focus:ring-red-500]="isCellInvalid(i, header)"
                         [class.focus:border-red-500]="isCellInvalid(i, header)"
                         [class.border-green-400]="!isCellInvalid(i, header) && relationHeaders.includes(header) && row[header]"
                         [class.bg-green-50]="!isCellInvalid(i, header) && relationHeaders.includes(header) && row[header]"
                         [class.focus:ring-green-500]="!isCellInvalid(i, header) && relationHeaders.includes(header)"
                         [class.border-slate-300]="!isCellInvalid(i, header) && !relationHeaders.includes(header)"
                         [class.focus:ring-blue-500]="!isCellInvalid(i, header) && !relationHeaders.includes(header)" />
                  
                  <!-- Status Indicator -->
                  <div class="flex items-center gap-1 text-xs">
                    <span *ngIf="isCellInvalid(i, header)" class="flex items-center gap-1 text-red-600">
                      <span class="material-icons" style="font-size: 14px;">error</span>
                      <span>Invalide</span>
                    </span>
                    <span *ngIf="!isCellInvalid(i, header) && relationHeaders.includes(header) && row[header]" class="flex items-center gap-1 text-green-600">
                      <span class="material-icons" style="font-size: 14px;">check_circle</span>
                      <span>Valide</span>
                    </span>
                  </div>
                </div>
              </td>
            </tr>
            
            <!-- Suggestions Row - Dedicated space -->
            <tr *ngIf="hasRowSuggestions(i)" class="bg-amber-50 border-b-2 border-amber-200">
              <td class="px-4 py-3 text-center text-xs font-medium text-amber-700 border-r border-amber-200">
                <span class="material-icons text-base">lightbulb</span>
              </td>
              <td *ngFor="let header of tableHeaders" 
                  class="px-4 py-3 border-r border-amber-200">
                <!-- Suggestions for this cell -->
                <div *ngIf="getSuggestions(i, header).length > 0 && isCellInvalid(i, header)" class="space-y-2">
                  <div class="text-xs font-semibold text-amber-900 mb-2">Suggestions :</div>
                  <div class="space-y-1">
                    <button *ngFor="let suggestion of getSuggestions(i, header); let j = index"
                            (click)="applySuggestion(i, header, suggestion)"
                            class="w-full text-left px-3 py-2 text-sm rounded-md transition-all hover:shadow-md"
                            [class.bg-blue-100]="j === 0"
                            [class.border-2]="j === 0"
                            [class.border-blue-400]="j === 0"
                            [class.bg-white]="j !== 0"
                            [class.border]="j !== 0"
                            [class.border-slate-300]="j !== 0"
                            [class.hover:bg-blue-50]="j === 0"
                            [class.hover:bg-slate-100]="j !== 0">
                      <div class="flex items-center gap-2">
                        <span class="material-icons text-blue-600" style="font-size: 16px;">check_circle</span>
                        <span class="flex-1 truncate">{{ suggestion.label }}</span>
                        <span *ngIf="j === 0" class="text-xs font-bold text-blue-700 bg-blue-200 px-2 py-0.5 rounded">TOP</span>
                      </div>
                    </button>
                  </div>
                </div>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Bottom action bar -->
  <div *ngIf="tableRows.length" class="flex-shrink-0 border-t border-slate-200 bg-white px-6 py-4 flex items-center justify-between bottom-action">
    <div class="text-sm text-slate-600">
      {{ hasInvalidCells() ? (getInvalidCellsCount() + ' erreur(s) à corriger') : 'Données prêtes à être importées' }}
    </div>
    <div class="flex items-center gap-3">
      <button type="button"
              (click)="addEmptyRow()"
              class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-slate-300 bg-white text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors">
        <span class="material-icons text-base">add</span>
        Ajouter une ligne
      </button>
      <button type="button"
              (click)="clearTable()"
              class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-slate-300 bg-white text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors">
        <span class="material-icons text-base">refresh</span>
        Réinitialiser
      </button>
      <button type="button"
              (click)="importExamens()"
              [disabled]="isImporting || hasInvalidCells()"
              class="inline-flex items-center gap-2 px-5 py-2 rounded-lg text-white text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              [class.bg-blue-600]="!hasInvalidCells()"
              [class.hover:bg-blue-700]="!hasInvalidCells()"
              [class.bg-slate-400]="hasInvalidCells()">
        <span class="material-icons text-base" *ngIf="!isImporting">cloud_upload</span>
        <span class="material-icons text-base animate-spin" *ngIf="isImporting">refresh</span>
        {{ isImporting ? 'Import...' : (hasInvalidCells() ? 'Erreurs' : 'Importer') }}
      </button>
    </div>
  </div>

  <!-- Import Results -->
  <div *ngIf="importResult" class="flex-shrink-0 border-t border-slate-200 bg-white px-6 py-4">
    <div class="flex items-start gap-3">
      <span class="material-icons text-lg" [class.text-green-500]="importResult.success" [class.text-red-500]="!importResult.success">
        {{ importResult.success ? 'check_circle' : 'error' }}
      </span>
      <div class="flex-1">
        <p class="font-medium" [class.text-green-700]="importResult.success" [class.text-red-700]="!importResult.success">
          {{ importResult.message }}
        </p>
        <div *ngIf="importResult.details" class="mt-2 flex gap-4 text-sm">
          <span class="text-slate-600">Total: {{ importResult.details.total || 0 }}</span>
          <span class="text-green-600">Créés: {{ importResult.details.created || 0 }}</span>
          <span class="text-blue-600">Mis à jour: {{ importResult.details.updated || 0 }}</span>
          <span class="text-red-600">Erreurs: {{ importResult.details.errors || 0 }}</span>
        </div>
      </div>
    </div>
  </div>
</div>
