<div class="min-h-screen bg-gray-50 py-10">
  <div class="max-w-6xl mx-auto px-4 space-y-6">
    <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-6 space-y-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h1 class="text-2xl font-semibold text-gray-800">Importation simple des √©tudiants</h1>
          <p class="text-sm text-gray-500">T√©l√©chargez le mod√®le, remplissez-le et importez-le pour corriger directement les donn√©es.</p>
        </div>
        <div class="flex flex-wrap gap-3">
          <button type="button"
                  (click)="downloadTemplate()"
                  class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-100">
            <span class="material-icons text-base">download</span>
            T√©l√©charger le mod√®le
          </button>
          <label class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-medium cursor-pointer hover:bg-blue-700">
            <span class="material-icons text-base">file_upload</span>
            Importer un fichier
            <input type="file"
                   accept=".xlsx,.xls"
                   class="hidden"
                   (change)="onFileSelected($event)" />
          </label>
          <button *ngIf="tableRows.length"
                  type="button"
                  (click)="clearTable()"
                  class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-100">
            <span class="material-icons text-base">refresh</span>
            R√©initialiser
          </button>
          <button *ngIf="tableRows.length"
                  type="button"
                  (click)="importStudents()"
                  [disabled]="isImporting || hasInvalidCells()"
                  class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-white text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                  [class.bg-green-600]="!hasInvalidCells()"
                  [class.hover:bg-green-700]="!hasInvalidCells()"
                  [class.bg-gray-400]="hasInvalidCells()">
            <span class="material-icons text-base" *ngIf="!isImporting">cloud_upload</span>
            <span class="material-icons text-base animate-spin" *ngIf="isImporting">refresh</span>
            {{ isImporting ? 'Importation...' : (hasInvalidCells() ? 'Corrigez les erreurs d\'abord' : 'Importer les √©tudiants') }}
          </button>
        </div>
      </div>

      <div *ngIf="fileName" class="text-sm text-gray-500">
        Fichier s√©lectionn√© : <span class="font-medium text-gray-700">{{ fileName }}</span>
      </div>

      <div *ngIf="errorMessage" class="rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-600">
        {{ errorMessage }}
      </div>

      <div *ngIf="successMessage" class="rounded-lg border border-green-200 bg-green-50 px-4 py-3 text-sm text-green-700">
        {{ successMessage }}
      </div>

      <div *ngIf="isProcessing" class="rounded-lg border border-blue-200 bg-blue-50 px-4 py-3 text-sm text-blue-700">
        Lecture du fichier en cours...
      </div>

      <div *ngIf="referenceError" class="rounded-lg border border-yellow-200 bg-yellow-50 px-4 py-3 text-sm text-yellow-700">
        {{ referenceError }}
      </div>

      <!-- Information sur la validation -->
      <div *ngIf="tableRows.length && filterOptions" class="rounded-lg border border-blue-200 bg-blue-50 px-4 py-3 text-sm text-blue-700">
        <div class="flex items-start gap-2">
          <span class="material-icons text-base mt-0.5">info</span>
          <div>
            <p class="font-medium mb-1">Validation automatique activ√©e</p>
            <p>Les colonnes marqu√©es avec ‚ö° sont valid√©es automatiquement. Les valeurs incorrectes seront surlign√©es en rouge avec des suggestions disponibles.</p>
          </div>
        </div>
      </div>

      <!-- √âtat de validation -->
      <div *ngIf="tableRows.length" class="rounded-lg border px-4 py-3 text-sm"
           [class.border-red-200]="hasInvalidCells()"
           [class.bg-red-50]="hasInvalidCells()"
           [class.text-red-700]="hasInvalidCells()"
           [class.border-green-200]="!hasInvalidCells()"
           [class.bg-green-50]="!hasInvalidCells()"
           [class.text-green-700]="!hasInvalidCells()">
        <div class="flex items-center gap-2">
          <span class="material-icons text-base" *ngIf="hasInvalidCells()">warning</span>
          <span class="material-icons text-base" *ngIf="!hasInvalidCells()">check_circle</span>
          <div>
            <p class="font-medium" *ngIf="hasInvalidCells()">
              {{ getInvalidCellsCount() }} erreur(s) d√©tect√©e(s) - Corrigez les erreurs avant l'importation
            </p>
            <p class="font-medium" *ngIf="!hasInvalidCells()">
              ‚úÖ Toutes les donn√©es sont valides - Pr√™t pour l'importation
            </p>
          </div>
        </div>
      </div>

      <!-- Debug temporaire -->
      <div *ngIf="tableRows.length" class="rounded-lg border border-gray-300 bg-gray-100 px-4 py-3 text-xs text-gray-600">
        <p><strong>Debug:</strong> hasInvalidCells() = {{ hasInvalidCells() }}, Invalid count = {{ getInvalidCellsCount() }}</p>
        <p><strong>Invalid cells:</strong> {{ getInvalidCellsDebug() }}</p>
      </div>

      <!-- R√©sultat de l'importation -->
      <div *ngIf="importResult" class="rounded-lg border px-4 py-3 text-sm"
           [class.border-green-200]="importResult.success"
           [class.bg-green-50]="importResult.success"
           [class.text-green-700]="importResult.success"
           [class.border-red-200]="!importResult.success"
           [class.bg-red-50]="!importResult.success"
           [class.text-red-700]="!importResult.success">
        <div class="flex items-start gap-2">
          <span class="material-icons text-base" *ngIf="importResult.success">check_circle</span>
          <span class="material-icons text-base" *ngIf="!importResult.success">error</span>
          <div>
            <p class="font-medium mb-1">{{ importResult.message }}</p>
            <div *ngIf="importResult.details" class="text-xs mt-2">
              <p *ngIf="importResult.details.total">Total: {{ importResult.details.total }}</p>
              <p *ngIf="importResult.details.created">Cr√©√©s: {{ importResult.details.created }}</p>
              <p *ngIf="importResult.details.updated">Mis √† jour: {{ importResult.details.updated }}</p>
              <p *ngIf="importResult.details.errors">Erreurs: {{ importResult.details.errors }}</p>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="tableRows.length" class="overflow-x-auto border border-gray-200 rounded-xl bg-white">
        <table class="min-w-full divide-y divide-gray-200 text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-3 text-left font-medium text-gray-600">#</th>
              <th *ngFor="let header of tableHeaders; trackBy: trackByHeader"
                  class="px-4 py-3 text-left font-medium text-gray-600 min-w-32">
                <div class="flex items-center gap-2">
                  <span>{{ getHeaderDisplayName(header) }}</span>
                  <span *ngIf="relationHeaders.includes(header)" 
                        class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full"
                        title="Cette colonne n√©cessite une validation">
                    ‚ö°
                  </span>
                </div>
              </th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            <tr *ngFor="let row of tableRows; index as i; trackBy: trackByRow" class="hover:bg-gray-50">
              <td class="px-4 py-3 text-gray-500">{{ i + 1 }}</td>
              <td *ngFor="let header of tableHeaders; trackBy: trackByHeader" class="px-4 py-3 align-top min-w-32">
                <div class="flex flex-col gap-2">
                  <input [(ngModel)]="tableRows[i][header]"
                         (ngModelChange)="updateCell(i, header, $event)"
                         class="w-full rounded-md border px-3 py-2 text-sm text-gray-800 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500 min-w-40"
                         [class.border-red-400]="isCellInvalid(i, header)"
                         [class.border-gray-300]="!isCellInvalid(i, header)"
                         [class.bg-red-50]="isCellInvalid(i, header)"
                         [placeholder]="getPlaceholder(header)"
                         [title]="tableRows[i][header] || ''"
                         type="text" />

                  <!-- Aper√ßu plein texte pour longue valeur -->
                  <div *ngIf="showFullValue(tableRows[i][header])"
                       class="text-[11px] text-gray-600 bg-gray-50 border border-gray-200 rounded px-2 py-1 break-words">
                    {{ tableRows[i][header] }}
                  </div>

                  <!-- Suggestions pour les cellules invalides -->
                  <div *ngIf="isCellInvalid(i, header) && getSuggestions(i, header).length"
                       class="rounded-md border border-blue-200 bg-blue-50 text-xs text-blue-700">
                    <div class="px-3 py-2 font-medium border-b border-blue-200">üí° Suggestions disponibles</div>
                    <div class="divide-y divide-blue-100">
                      <button type="button"
                              *ngFor="let suggestion of getSuggestions(i, header)"
                              (click)="applySuggestion(i, header, suggestion)"
                              class="w-full text-left px-3 py-2 hover:bg-blue-100 focus:outline-none focus:bg-blue-100 transition-colors">
                        {{ suggestion.label }}
                      </button>
                    </div>
                  </div>

                  <!-- Message d'erreur pour les cellules sans suggestions -->
                  <div *ngIf="isCellInvalid(i, header) && !getSuggestions(i, header).length"
                       class="text-xs text-red-600 bg-red-50 px-2 py-1 rounded border border-red-200">
                    ‚ö†Ô∏è Valeur inconnue, veuillez corriger manuellement.
                  </div>

                  <!-- Indicateur de validation pour les cellules valides -->
                  <div *ngIf="!isCellInvalid(i, header) && relationHeaders.includes(header) && tableRows[i][header]?.trim()"
                       class="text-xs text-green-600 bg-green-50 px-2 py-1 rounded border border-green-200">
                    ‚úÖ Valeur valide
                  </div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div *ngIf="!tableRows.length" class="rounded-xl border border-dashed border-gray-300 bg-gray-50 px-6 py-10 text-center text-gray-500">
        <div class="flex flex-col items-center gap-3">
          <span class="material-icons text-4xl text-gray-300">table_chart</span>
          <p class="text-sm">Importez un fichier Excel pour pr√©visualiser et modifier les informations des √©tudiants avant importation.</p>
          <p *ngIf="!filterOptions" class="text-xs text-gray-400">Chargement des donn√©es de r√©f√©rence...</p>
        </div>
      </div>
    </div>
  </div>
</div>
