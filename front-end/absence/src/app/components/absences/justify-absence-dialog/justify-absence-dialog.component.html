<div class="justify-dialog-container">
  <h2 mat-dialog-title class="dialog-title">
    <mat-icon>description</mat-icon>
    <span>Justifier une absence</span>
  </h2>

  <mat-dialog-content class="dialog-content">
    <!-- Informations de l'étudiant -->
    <div class="student-info-card">
      <div class="info-grid">
        <div class="info-item">
          <span class="label">Étudiant</span>
          <span class="value">{{ getStudentName() }}</span>
        </div>
        <div class="info-item">
          <span class="label">Matricule</span>
          <span class="value">{{ getStudentMatricule() }}</span>
        </div>
        <div class="info-item">
          <span class="label">Date d'absence</span>
          <span class="value">{{ formatDate(data.absence.date_absence) }}</span>
        </div>
        <div class="info-item">
          <span class="label">Type</span>
          <span class="value">{{ data.absence.type_absence }}</span>
        </div>
      </div>
    </div>

    <form [formGroup]="justifyForm" class="justify-form">
      <!-- Statut -->
      <div class="custom-select-wrapper">
        <label class="custom-select-label">
          Statut <span class="required-asterisk">*</span>
        </label>
        <div class="custom-select" [class.open]="isStatusDropdownOpen">
          <div class="custom-select-trigger" [ngClass]="getStatusClass()" (click)="toggleStatusDropdown()">
            <div class="selected-option">
              <mat-icon class="status-icon">{{ getStatusIcon() }}</mat-icon>
              <span class="status-text">{{ getStatusText() }}</span>
            </div>
            <mat-icon class="dropdown-arrow">keyboard_arrow_down</mat-icon>
          </div>
          <div class="custom-select-options" *ngIf="isStatusDropdownOpen" (click)="$event.stopPropagation()">
            <div 
              class="custom-option" 
              [class.selected]="justifyForm.get('justifiee')?.value === true"
              [class.status-justified]="true"
              (click)="selectStatus(true)"
            >
              <mat-icon class="option-icon">check_circle</mat-icon>
              <span>Justifiée</span>
            </div>
            <div 
              class="custom-option" 
              [class.selected]="justifyForm.get('justifiee')?.value === false"
              [class.status-unjustified]="true"
              (click)="selectStatus(false)"
            >
              <mat-icon class="option-icon">cancel</mat-icon>
              <span>Non justifiée</span>
            </div>
          </div>
        </div>
        <p class="custom-select-hint">Choisissez le statut de justification de l'absence</p>
      </div>

      <!-- Motif -->
      <div class="custom-textarea-wrapper">
        <label class="custom-textarea-label">
          Motif de l'absence <span class="required-asterisk">*</span>
        </label>
        <div class="custom-textarea-container" [class.error]="justifyForm.get('motif')?.invalid && justifyForm.get('motif')?.touched">
          <textarea 
            formControlName="motif" 
            rows="5"
            placeholder="Ex: Certificat médical, décès dans la famille, rendez-vous médical urgent, etc."
            maxlength="500"
            class="custom-textarea"
          ></textarea>
          <div class="textarea-footer">
            <div class="textarea-errors">
              <span class="error-message" *ngIf="justifyForm.get('motif')?.hasError('required') && justifyForm.get('motif')?.touched">
                Le motif est requis
              </span>
              <span class="error-message" *ngIf="justifyForm.get('motif')?.hasError('maxlength') && justifyForm.get('motif')?.touched">
                Le motif ne doit pas dépasser 500 caractères
              </span>
            </div>
            <span class="character-count" [class.warning]="(justifyForm.get('motif')?.value?.length || 0) > 450">
              {{ justifyForm.get('motif')?.value?.length || 0 }}/500
            </span>
          </div>
        </div>
      </div>

      <!-- Upload de fichier -->
      <div class="file-upload-section">
        <label class="upload-label">Justificatif (optionnel)</label>
        
        <div 
          class="file-drop-zone"
          [class.has-file]="selectedFile"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (drop)="onDrop($event)"
        >
          <input 
            type="file" 
            #fileInput 
            (change)="onFileSelected($event)"
            accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
            style="display: none"
          />

          <div *ngIf="!selectedFile" class="upload-placeholder">
            <mat-icon class="upload-icon">cloud_upload</mat-icon>
            <p class="upload-text">Glissez-déposez un fichier ici ou</p>
            <button 
              mat-stroked-button 
              type="button"
              (click)="fileInput.click()"
              class="browse-button"
            >
              Parcourir
            </button>
            <p class="upload-hint">
              Formats acceptés: PDF, JPG, PNG, DOC, DOCX (max 5MB)
            </p>
          </div>

          <div *ngIf="selectedFile" class="file-preview">
            <mat-icon class="file-icon">description</mat-icon>
            <div class="file-info">
              <p class="file-name">{{ fileName }}</p>
              <p class="file-size">{{ formatFileSize(selectedFile.size) }}</p>
            </div>
            <button 
              mat-icon-button 
              type="button"
              (click)="removeFile()"
              class="remove-button"
              matTooltip="Supprimer le fichier"
            >
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </div>

        <!-- Afficher le justificatif existant s'il y en a un -->
        <div *ngIf="data.absence.justificatif && !selectedFile" class="existing-file">
          <mat-icon>attach_file</mat-icon>
          <span>Justificatif existant: {{ data.absence.justificatif }}</span>
          <button 
            mat-icon-button 
            type="button"
            (click)="downloadExistingFile()"
            matTooltip="Télécharger"
          >
            <mat-icon>download</mat-icon>
          </button>
        </div>
      </div>
    </form>
  </mat-dialog-content>

  <mat-dialog-actions class="dialog-actions">
    <button 
      mat-button 
      (click)="onCancel()"
      [disabled]="isUploading"
    >
      Annuler
    </button>
    <button 
      mat-raised-button 
      color="primary"
      (click)="onSubmit()"
      [disabled]="justifyForm.invalid || isUploading"
    >
      <mat-spinner *ngIf="isUploading" diameter="20" class="spinner"></mat-spinner>
      <span *ngIf="!isUploading">Enregistrer</span>
      <span *ngIf="isUploading">Enregistrement...</span>
    </button>
  </mat-dialog-actions>
</div>
